{% extends "base.html" %}

{% block content %}
<style>
@media print {
    /* Hide ALL non-content elements - Safari specific */
    #sidebar-wrapper,
    #page-content-wrapper > nav,
    .btn, 
    button:not(.d-print-none), 
    .modal, 
    .no-print, 
    nav, 
    .navbar, 
    header, 
    .sidebar,
    .alert,
    form,
    a.btn,
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-danger,
    .btn-warning {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
    }
    
    /* Reset all body and wrapper styles */
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: auto !important;
    }
    
    #page-content-wrapper {
        margin-left: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    
    /* Make main content visible and full width */
    .container {
        max-width: 100% !important;
        padding: 10px !important;
        margin: 0 !important;
        width: 100% !important;
    }
    
    /* Keep header on same page as content */
    h1 {
        page-break-after: avoid !important;
        margin-top: 0 !important;
        font-size: 18px !important;
    }
    
    .card.mb-4:first-of-type {
        page-break-after: avoid !important;
    }
    
    /* Adjust layout for printing */
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid !important;
        box-shadow: none !important;
        margin-bottom: 10px !important;
    }
    
    .card-body {
        padding: 10px !important;
    }
    
    /* Better table printing */
    .table-responsive {
        overflow: visible !important;
        border: none !important;
    }
    
    table {
        page-break-inside: auto !important;
        font-size: 9px !important;
        width: 100% !important;
        border-collapse: collapse !important;
    }
    
    thead {
        display: table-header-group !important;
    }
    
    tr {
        page-break-inside: avoid !important;
        page-break-after: auto !important;
    }
    
    th, td {
        padding: 4px !important;
        border: 1px solid #000 !important;
    }
    
    /* Hide Amount and Actions columns when printing (use classes for stability) */
    th.amount, td.amount,
    th.actions, td.actions {
        display: none !important;
    }
    
    /* Keep Financial Summary on same page */
    .card.mt-4 {
        page-break-before: avoid !important;
        page-break-inside: avoid !important;
    }
    
    /* Financial summary adjustments */
    .d-flex {
        display: flex !important;
    }
    
    /* Hide any remaining interactive elements */
    input, select, textarea, .form-control, .form-select {
        display: none !important;
    }
}

/* Print button - only visible on screen */
@media screen {
    .print-only {
        display: none;
    }
}
</style>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Courier Details: {{ courier.courier_id }}</h1>
        <a href="{{ url_for('couriers') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Couriers
        </a>
    </div>
    
    <!-- Courier Information -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Courier Information</h5>
            <p><strong>Courier ID:</strong> {{ courier.courier_id }}</p>
            <p><strong>Date:</strong> {{ courier.date.strftime('%Y-%m-%d') }}</p>
            <p><strong>Total Items:</strong> {{ items|length }}</p>
            {% if courier.brought_by_name %}
            <p><strong>Brought By:</strong> {{ courier.brought_by_name }}</p>
            {% endif %}
            {% if courier.brought_by_phone %}
            <p>
                <strong>WhatsApp:</strong> {{ courier.brought_by_phone }}
                <a href="https://wa.me/{{ courier.brought_by_phone.replace('+', '').replace(' ', '').replace('-', '') }}" 
                   target="_blank" 
                   class="btn btn-success btn-sm ms-2">
                    <i class="fab fa-whatsapp"></i> Open WhatsApp
                </a>
            </p>
            {% endif %}
            {% if courier.assigned_to %}
            <p><strong>Assigned To:</strong> {{ courier.assigned_to }}</p>
            {% endif %}
            {% if courier_photo_url %}
            <div class="mt-3">
                <img src="{{ courier_photo_url }}" alt="Courier Photo" style="max-height:160px; max-width:220px; object-fit:cover;" class="img-thumbnail">
            </div>
            {% endif %}
            <div class="mt-3">
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editCourierModal">
                    <i class="fas fa-edit"></i> Edit Courier Information
                </button>
            </div>
        </div>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Add Item Form -->
    {% set approved_items = items|selectattr('is_received', 'equalto', True)|list %}
    {% if current_user.role != 'Secretary' and approved_items|length == 0 %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Add New Item</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('add_courier_item', id=courier.id) }}" method="POST">
                <div class="row">
                    <div class="col-md-2 mb-3">
                        <label for="container_number" class="form-label">Container</label>
                        <select class="form-select" id="container_number" name="container_number" onchange="updateSenderOptions()">
                            <option value="">-- Optional --</option>
                            {% for container in active_containers %}
                            <option value="{{ container.container_number }}">{{ container.container_name or container.container_number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="sender_name" class="form-label">Sender Name</label>
                        <select class="form-select" id="sender_name_select" name="sender_name" style="display:none;" required>
                            <option value="">-- Select Client Mark --</option>
                        </select>
                        <input type="text" class="form-control" id="sender_name_input" name="sender_name" placeholder="Enter sender name" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="receiver_name" class="form-label">Receiver Name</label>
                        <input type="text" class="form-control" id="receiver_name" name="receiver_name" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="amount" class="form-label">Amount (€)</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="service" class="form-label">Service (€)</label>
                        <input type="number" step="0.01" class="form-control" id="service" name="service" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="exchange_rate" class="form-label">Exchange Rate</label>
                        <input type="number" step="0.0001" class="form-control" id="exchange_rate" name="exchange_rate" value="4.10" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Items Table -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Courier Items</h5>
                {% if current_user.role == 'Secretary' %}
                    {% set approved_items = items|selectattr('is_received', 'equalto', True)|list %}
                    {% if approved_items|length == 0 and items|length > 0 %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveAllModal">
                        <i class="fas fa-check-double"></i> Approve All Items
                    </button>
                    {% elif approved_items|length > 0 %}
                    <span class="badge bg-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
                        <i class="fas fa-check-circle"></i> Already Approved
                    </span>
                    {% endif %}
                {% endif %}
            </div>
            {% if items %}
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>NO</th>
                            <th>Container</th>
                            <th>Sender Name</th>
                            <th>Receiver Name</th>
                            <th class="amount">Amount (€)</th>
                            <th class="service">Service (€)</th>
                            <th>Exchange Rate</th>
                            <th class="money-euro">Money in EURO</th>
                            <th>Money in AED</th>
                            <th>Market Rate</th>
                            <th>Money Received</th>
                            <th class="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr id="item-{{ item.id }}">
                            <td>{{ loop.index }}</td>
                            <td class="container-number">
                                {% if item.container_number and containers_map.get(item.container_number) %}
                                    {{ containers_map[item.container_number].container_name or containers_map[item.container_number].container_number }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="sender-name">{{ item.sender_name }}</td>
                            <td class="receiver-name">{{ item.receiver_name }}</td>
                            <td class="amount">{{ "{:,.0f}".format(item.amount) }} EUR</td>
                            <td class="service">{{ "{:,.0f}".format(item.service) }} EUR</td>
                            <td class="exchange-rate">{{ "%.4f"|format(item.exchange_rate) }}</td>
                            <td><strong>{{ "{:,.0f}".format(item.money_in_euro) }} EUR</strong></td>
                            <td><strong>{{ "{:,.0f}".format(item.money_in_aed) }} AED</strong></td>
                            <td class="market-rate">
                                {% if item.is_received %}
                                    {{ "%.4f"|format(item.market_exchange_rate) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="money-received">
                                {% if item.is_received and item.money_received %}
                                    <strong class="text-success">{{ "{:,.0f}".format(item.money_received) }} AED</strong>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="actions">
                                {% if current_user.role == 'Secretary' %}
                                    {% if item.is_received %}
                                        <span class="badge bg-success">Received</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                {% else %}
                                    {% if item.is_received %}
                                        <span class="badge bg-success">Approved</span>
                                    {% else %}
                                        <button class="btn btn-sm btn-warning edit-item-btn" 
                                                data-item-id="{{ item.id }}"
                                                data-container="{{ item.container_number or '' }}"
                                                data-sender="{{ item.sender_name }}"
                                                data-receiver="{{ item.receiver_name }}"
                                                data-amount="{{ item.amount }}"
                                                data-service="{{ item.service }}"
                                                data-rate="{{ item.exchange_rate }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-item-btn" 
                                                data-item-id="{{ item.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- Totals Row -->
                        <tr class="table-secondary fw-bold">
                            <td colspan="4">TOTAL</td>
                            <td class="amount">{{ "{:,.0f}".format(total_amount) }} EUR</td>
                            <td class="service">{{ "{:,.0f}".format(total_service) }} EUR</td>
                            <td></td>
                            <td class="money-euro"><strong>{{ "{:,.0f}".format(total_euro) }} EUR</strong></td>
                            <td><strong>{{ "{:,.0f}".format(total_aed) }} AED</strong></td>
                            <td></td>
                            <td>
                                {% if total_money_received %}
                                    <strong class="text-success">{{ "{:,.0f}".format(total_money_received) }} AED</strong>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="actions"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No items added yet.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Financial Summary (only show if courier is approved) -->
    {% set approved_items = items|selectattr('is_received', 'equalto', True)|list %}
    {% if approved_items|length > 0 and total_money_received %}
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-chart-line"></i> Financial Summary</h5>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-around align-items-center flex-wrap">
                <div class="text-center px-3">
                    <h6 class="text-muted mb-1">Total Money in AED</h6>
                    <h4 class="text-primary mb-0">{{ "{:,.0f}".format(total_aed) }} AED</h4>
                    <small class="text-muted">Based on exchange rate</small>
                </div>
                <div class="text-center px-3">
                    <h6 class="text-muted mb-1">Total Money Received</h6>
                    <h4 class="text-success mb-0">{{ "{:,.0f}".format(total_money_received) }} AED</h4>
                    <small class="text-muted">Based on market rate</small>
                </div>
                <div class="text-center px-3">
                    <h6 class="text-muted mb-1">Benefit/Loss</h6>
                    <h4 class="text-{{ 'success' if benefit >= 0 else 'danger' }} mb-0">
                        {{ "{:,.0f}".format(benefit) }} AED
                    </h4>
                    <small class="text-muted">{{ "%.2f"|format((benefit / total_aed * 100) if total_aed > 0 else 0) }}% {{ 'profit' if benefit >= 0 else 'loss' }}</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Cash Counting (Billetage) Section - Only show if courier is active (not approved) and user is not Secretary/Manager -->
    {% set has_items = items|length > 0 %}
    {% set is_not_approved = approved_items|length == 0 %}
    {% if has_items and is_not_approved and current_user.role not in ['Secretary', 'Manager'] %}
    <div class="card mt-4 no-print">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-coins"></i> Cash Counting (Billetage)</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('add_courier_billetage', courier_id=courier.id) }}">
                <div class="row">
                    <!-- AED Denominations (Left Side) -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3"><i class="fas fa-money-bill"></i> AED Denominations</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">1000 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_1000" 
                                       id="aed_1000" value="0" min="0" data-value="1000">
                            </div>
                            <div class="col-6">
                                <label class="form-label">500 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_500" 
                                       id="aed_500" value="0" min="0" data-value="500">
                            </div>
                            <div class="col-6">
                                <label class="form-label">200 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_200" 
                                       id="aed_200" value="0" min="0" data-value="200">
                            </div>
                            <div class="col-6">
                                <label class="form-label">100 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_100" 
                                       id="aed_100" value="0" min="0" data-value="100">
                            </div>
                            <div class="col-6">
                                <label class="form-label">50 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_50" 
                                       id="aed_50" value="0" min="0" data-value="50">
                            </div>
                            <div class="col-6">
                                <label class="form-label">20 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_20" 
                                       id="aed_20" value="0" min="0" data-value="20">
                            </div>
                            <div class="col-6">
                                <label class="form-label">10 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_10" 
                                       id="aed_10" value="0" min="0" data-value="10">
                            </div>
                            <div class="col-6">
                                <label class="form-label">5 AED</label>
                                <input type="number" class="form-control denomination-input" name="aed_5" 
                                       id="aed_5" value="0" min="0" data-value="5">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Euro Denominations (Right Side) -->
                    <div class="col-md-6">
                        <h6 class="text-success mb-3"><i class="fas fa-euro-sign"></i> Euro Denominations</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">500 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_500" 
                                       id="euro_500" value="0" min="0" data-value="500">
                            </div>
                            <div class="col-6">
                                <label class="form-label">200 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_200" 
                                       id="euro_200" value="0" min="0" data-value="200">
                            </div>
                            <div class="col-6">
                                <label class="form-label">100 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_100" 
                                       id="euro_100" value="0" min="0" data-value="100">
                            </div>
                            <div class="col-6">
                                <label class="form-label">50 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_50" 
                                       id="euro_50" value="0" min="0" data-value="50">
                            </div>
                            <div class="col-6">
                                <label class="form-label">20 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_20" 
                                       id="euro_20" value="0" min="0" data-value="20">
                            </div>
                            <div class="col-6">
                                <label class="form-label">10 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_10" 
                                       id="euro_10" value="0" min="0" data-value="10">
                            </div>
                            <div class="col-6">
                                <label class="form-label">5 EUR</label>
                                <input type="number" class="form-control denomination-input-euro" name="euro_5" 
                                       id="euro_5" value="0" min="0" data-value="5">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exchange Rate for Euro to AED -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Exchange Rate (EUR to AED)</label>
                        <input type="number" step="0.0001" class="form-control" name="euro_to_aed_rate" 
                               id="euro_to_aed_rate" value="4.0" required>
                        <small class="text-muted">Rate to convert EUR to AED for comparison</small>
                    </div>
                </div>
                
                <!-- Summary Display -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Counted AED:</strong>
                                    <div class="h5 mb-0" id="total_aed_counted">0 AED</div>
                                </div>
                                <div class="col-md-3">
                                    <strong>Counted EUR (in AED):</strong>
                                    <div class="h5 mb-0" id="total_euro_in_aed">0 AED</div>
                                </div>
                                <div class="col-md-3">
                                    <strong>Total Counted:</strong>
                                    <div class="h5 mb-0 text-primary" id="total_counted">0 AED</div>
                                </div>
                                <div class="col-md-3">
                                    <strong>Expected:</strong>
                                    <div class="h5 mb-0">{{ "{:,.0f}".format(total_aed) }} AED</div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <strong>Difference:</strong>
                                    <div class="h4 mb-0" id="difference_display">
                                        <span id="difference_amount">0</span> AED
                                        <span id="difference_status" class="badge"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2" 
                                  placeholder="Any additional notes about the cash count"></textarea>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Cash Count
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Display Previous Billetages - Always show if there are any -->
    {% if courier_billetages %}
    <div class="card mt-4 no-print">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-history"></i> Cash Count History</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total AED</th>
                            <th>Total EUR (in AED)</th>
                            <th>Total Counted</th>
                            <th>Expected</th>
                            <th>Difference</th>
                            <th>Counted By</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for billetage in courier_billetages %}
                        <tr>
                            <td>{{ billetage.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ "{:,.0f}".format(billetage.total_aed) }} AED</td>
                            <td>{{ "{:,.0f}".format(billetage.total_euro_in_aed) }} AED</td>
                            <td><strong>{{ "{:,.0f}".format(billetage.total_counted) }} AED</strong></td>
                            <td>{{ "{:,.0f}".format(billetage.expected_amount) }} AED</td>
                            <td>
                                <span class="badge bg-{{ 'success' if billetage.difference == 0 else ('warning' if billetage.difference|abs < 100 else 'danger') }}">
                                    {{ "{:,.0f}".format(billetage.difference) }} AED
                                </span>
                            </td>
                            <td>{{ billetage.counted_by_user.username if billetage.counted_by_user else 'Unknown' }}</td>
                            <td>{{ billetage.notes or '-' }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" 
                                            data-bs-target="#viewBilletageModal{{ billetage.id }}" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% if current_user.role not in ['Secretary', 'Manager'] %}
                                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" 
                                            data-bs-target="#editBilletageModal{{ billetage.id }}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            onclick="deleteBilletage({{ billetage.id }}, {{ courier.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="mt-3">
        <a href="{{ url_for('couriers') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Couriers
        </a>
        <button onclick="window.print()" class="btn btn-primary">
            <i class="fas fa-print"></i> Print
        </button>
    </div>
</div>

<!-- Billetage Modals -->
{% for billetage in courier_billetages %}
<!-- View Billetage Modal -->
<div class="modal fade" id="viewBilletageModal{{ billetage.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cash Count Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="text-primary">AED Denominations</h6>
                        <table class="table table-sm">
                            {% if billetage.aed_1000 > 0 %}<tr><td>1000 AED:</td><td><strong>{{ billetage.aed_1000 }}</strong> × 1000 = {{ billetage.aed_1000 * 1000 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_500 > 0 %}<tr><td>500 AED:</td><td><strong>{{ billetage.aed_500 }}</strong> × 500 = {{ billetage.aed_500 * 500 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_200 > 0 %}<tr><td>200 AED:</td><td><strong>{{ billetage.aed_200 }}</strong> × 200 = {{ billetage.aed_200 * 200 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_100 > 0 %}<tr><td>100 AED:</td><td><strong>{{ billetage.aed_100 }}</strong> × 100 = {{ billetage.aed_100 * 100 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_50 > 0 %}<tr><td>50 AED:</td><td><strong>{{ billetage.aed_50 }}</strong> × 50 = {{ billetage.aed_50 * 50 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_20 > 0 %}<tr><td>20 AED:</td><td><strong>{{ billetage.aed_20 }}</strong> × 20 = {{ billetage.aed_20 * 20 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_10 > 0 %}<tr><td>10 AED:</td><td><strong>{{ billetage.aed_10 }}</strong> × 10 = {{ billetage.aed_10 * 10 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_5 > 0 %}<tr><td>5 AED:</td><td><strong>{{ billetage.aed_5 }}</strong> × 5 = {{ billetage.aed_5 * 5 }} AED</td></tr>{% endif %}
                            {% if billetage.aed_1000 == 0 and billetage.aed_500 == 0 and billetage.aed_200 == 0 and billetage.aed_100 == 0 and billetage.aed_50 == 0 and billetage.aed_20 == 0 and billetage.aed_10 == 0 and billetage.aed_5 == 0 %}
                            <tr><td colspan="2" class="text-muted">No AED denominations counted</td></tr>
                            {% endif %}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Euro Denominations</h6>
                        <table class="table table-sm">
                            {% if billetage.euro_500 > 0 %}<tr><td>500 EUR:</td><td><strong>{{ billetage.euro_500 }}</strong> × 500 = {{ billetage.euro_500 * 500 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_200 > 0 %}<tr><td>200 EUR:</td><td><strong>{{ billetage.euro_200 }}</strong> × 200 = {{ billetage.euro_200 * 200 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_100 > 0 %}<tr><td>100 EUR:</td><td><strong>{{ billetage.euro_100 }}</strong> × 100 = {{ billetage.euro_100 * 100 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_50 > 0 %}<tr><td>50 EUR:</td><td><strong>{{ billetage.euro_50 }}</strong> × 50 = {{ billetage.euro_50 * 50 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_20 > 0 %}<tr><td>20 EUR:</td><td><strong>{{ billetage.euro_20 }}</strong> × 20 = {{ billetage.euro_20 * 20 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_10 > 0 %}<tr><td>10 EUR:</td><td><strong>{{ billetage.euro_10 }}</strong> × 10 = {{ billetage.euro_10 * 10 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_5 > 0 %}<tr><td>5 EUR:</td><td><strong>{{ billetage.euro_5 }}</strong> × 5 = {{ billetage.euro_5 * 5 }} EUR</td></tr>{% endif %}
                            {% if billetage.euro_500 == 0 and billetage.euro_200 == 0 and billetage.euro_100 == 0 and billetage.euro_50 == 0 and billetage.euro_20 == 0 and billetage.euro_10 == 0 and billetage.euro_5 == 0 %}
                            <tr><td colspan="2" class="text-muted">No Euro denominations counted</td></tr>
                            {% endif %}
                        </table>
                        <p><strong>Exchange Rate:</strong> {{ billetage.euro_to_aed_rate }} AED per EUR</p>
                    </div>
                </div>
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-6"><strong>Total AED:</strong> {{ "{:,.0f}".format(billetage.total_aed) }} AED</div>
                        <div class="col-md-6"><strong>Total EUR (in AED):</strong> {{ "{:,.0f}".format(billetage.total_euro_in_aed) }} AED</div>
                        <div class="col-md-6"><strong>Total Counted:</strong> {{ "{:,.0f}".format(billetage.total_counted) }} AED</div>
                        <div class="col-md-6"><strong>Expected:</strong> {{ "{:,.0f}".format(billetage.expected_amount) }} AED</div>
                        <div class="col-md-12 mt-2"><strong>Difference:</strong> 
                            <span class="badge bg-{{ 'success' if billetage.difference == 0 else ('warning' if billetage.difference|abs < 100 else 'danger') }}">
                                {{ "{:,.0f}".format(billetage.difference) }} AED
                            </span>
                        </div>
                    </div>
                </div>
                {% if billetage.notes %}
                <div class="mt-2">
                    <strong>Notes:</strong>
                    <p>{{ billetage.notes }}</p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Billetage Modal -->
<div class="modal fade" id="editBilletageModal{{ billetage.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Cash Count</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_courier_billetage', billetage_id=billetage.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">AED Denominations</h6>
                            <div class="row g-2">
                                <div class="col-6"><label class="form-label">1000 AED</label><input type="number" class="form-control" name="aed_1000" value="{{ billetage.aed_1000 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">500 AED</label><input type="number" class="form-control" name="aed_500" value="{{ billetage.aed_500 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">200 AED</label><input type="number" class="form-control" name="aed_200" value="{{ billetage.aed_200 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">100 AED</label><input type="number" class="form-control" name="aed_100" value="{{ billetage.aed_100 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">50 AED</label><input type="number" class="form-control" name="aed_50" value="{{ billetage.aed_50 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">20 AED</label><input type="number" class="form-control" name="aed_20" value="{{ billetage.aed_20 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">10 AED</label><input type="number" class="form-control" name="aed_10" value="{{ billetage.aed_10 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">5 AED</label><input type="number" class="form-control" name="aed_5" value="{{ billetage.aed_5 }}" min="0"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">Euro Denominations</h6>
                            <div class="row g-2">
                                <div class="col-6"><label class="form-label">500 EUR</label><input type="number" class="form-control" name="euro_500" value="{{ billetage.euro_500 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">200 EUR</label><input type="number" class="form-control" name="euro_200" value="{{ billetage.euro_200 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">100 EUR</label><input type="number" class="form-control" name="euro_100" value="{{ billetage.euro_100 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">50 EUR</label><input type="number" class="form-control" name="euro_50" value="{{ billetage.euro_50 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">20 EUR</label><input type="number" class="form-control" name="euro_20" value="{{ billetage.euro_20 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">10 EUR</label><input type="number" class="form-control" name="euro_10" value="{{ billetage.euro_10 }}" min="0"></div>
                                <div class="col-6"><label class="form-label">5 EUR</label><input type="number" class="form-control" name="euro_5" value="{{ billetage.euro_5 }}" min="0"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Exchange Rate (EUR to AED)</label>
                            <input type="number" step="0.0001" class="form-control" name="euro_to_aed_rate" value="{{ billetage.euro_to_aed_rate }}" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" rows="2">{{ billetage.notes or '' }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<script>
// Auto-calculate totals for billetage
document.addEventListener('DOMContentLoaded', function() {
    const expectedAmount = {{ total_aed if total_aed else 0 }};
    
    function updateBilletageTotals() {
        // Calculate AED total
        let aedTotal = 0;
        document.querySelectorAll('.denomination-input').forEach(input => {
            const count = parseInt(input.value) || 0;
            const value = parseInt(input.getAttribute('data-value'));
            aedTotal += count * value;
        });
        
        // Calculate EUR total
        let euroTotal = 0;
        document.querySelectorAll('.denomination-input-euro').forEach(input => {
            const count = parseInt(input.value) || 0;
            const value = parseInt(input.getAttribute('data-value'));
            euroTotal += count * value;
        });
        
        // Get exchange rate
        const euroToAedRate = parseFloat(document.getElementById('euro_to_aed_rate').value) || 4.0;
        
        // Convert EUR to AED
        const euroInAed = euroTotal * euroToAedRate;
        
        // Calculate total
        const totalCounted = aedTotal + euroInAed;
        
        // Calculate difference
        const difference = totalCounted - expectedAmount;
        
        // Update display
        document.getElementById('total_aed_counted').textContent = aedTotal.toLocaleString() + ' AED';
        document.getElementById('total_euro_in_aed').textContent = euroInAed.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' AED';
        document.getElementById('total_counted').textContent = totalCounted.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' AED';
        document.getElementById('difference_amount').textContent = difference.toLocaleString('en-US', {maximumFractionDigits: 0});
        
        // Update difference status badge
        const statusBadge = document.getElementById('difference_status');
        const diffDisplay = document.getElementById('difference_display');
        
        if (difference === 0) {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = '✓ Balanced';
            diffDisplay.className = 'h4 mb-0 text-success';
        } else if (difference > 0) {
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = '↑ Surplus';
            diffDisplay.className = 'h4 mb-0 text-warning';
        } else {
            statusBadge.className = 'badge bg-danger';
            statusBadge.textContent = '↓ Shortage';
            diffDisplay.className = 'h4 mb-0 text-danger';
        }
    }
    
    // Add event listeners to all denomination inputs
    document.querySelectorAll('.denomination-input, .denomination-input-euro').forEach(input => {
        input.addEventListener('input', updateBilletageTotals);
    });
    
    // Add event listener to exchange rate
    const rateInput = document.getElementById('euro_to_aed_rate');
    if (rateInput) {
        rateInput.addEventListener('input', updateBilletageTotals);
    }
    
    // Initial calculation
    updateBilletageTotals();
});

// Delete billetage function
function deleteBilletage(billetageId, courierId) {
    if (confirm('Are you sure you want to delete this cash count record?')) {
        fetch(`/courier/billetage/${billetageId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Cash count deleted successfully');
                window.location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting cash count');
            console.error('Error:', error);
        });
    }
}
</script>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editItemForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_item_id">
                    <div class="mb-3">
                        <label for="edit_container_number" class="form-label">Container</label>
                        <select class="form-select" id="edit_container_number" onchange="updateEditSenderOptions()">
                            <option value="">-- Optional --</option>
                            {% for container in active_containers %}
                            <option value="{{ container.container_number }}">{{ container.container_name or container.container_number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_sender_name" class="form-label">Sender Name</label>
                        <select class="form-select" id="edit_sender_name_select" style="display:none;">
                            <option value="">-- Select Client Mark --</option>
                        </select>
                        <input type="text" class="form-control" id="edit_sender_name_input" placeholder="Enter sender name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_receiver_name" class="form-label">Receiver Name</label>
                        <input type="text" class="form-control" id="edit_receiver_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_amount" class="form-label">Amount (€)</label>
                        <input type="number" step="0.01" class="form-control" id="edit_amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_service" class="form-label">Service (€)</label>
                        <input type="number" step="0.01" class="form-control" id="edit_service" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_exchange_rate" class="form-label">Exchange Rate</label>
                        <input type="number" step="0.0001" class="form-control" id="edit_exchange_rate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Courier Modal -->
<div class="modal fade" id="editCourierModal" tabindex="-1" aria-labelledby="editCourierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourierModalLabel">Edit Courier Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('edit_courier', id=courier.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="brought_by_name_edit" class="form-label">Brought By (Name)</label>
                        <input type="text" class="form-control" id="brought_by_name_edit" name="brought_by_name" value="{{ courier.brought_by_name or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="brought_by_phone_edit" class="form-label">WhatsApp Number</label>
                        <input type="text" class="form-control" id="brought_by_phone_edit" name="brought_by_phone" value="{{ courier.brought_by_phone or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="assigned_to_edit" class="form-label">Assigned To</label>
                        <input type="text" class="form-control" id="assigned_to_edit" name="assigned_to" value="{{ courier.assigned_to or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="photo_edit" class="form-label">Replace Photo (optional)</label>
                        <input class="form-control" type="file" id="photo_edit" name="photo" accept="image/*">
                        {% if courier.photo_filename %}
                        <small class="form-text text-muted">Current file: {{ courier.photo_filename }}</small>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Approve Item Modal (Secretary) -->
<div class="modal fade" id="approveItemModal" tabindex="-1" aria-labelledby="approveItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveItemModalLabel">Approve Courier Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveItemForm">
                <div class="modal-body">
                    <input type="hidden" id="approve_item_id">
                    <div class="mb-3">
                        <label for="market_exchange_rate" class="form-label">Market Exchange Rate (EUR to AED)</label>
                        <input type="number" step="0.0001" class="form-control" id="market_exchange_rate" placeholder="e.g., 4.1000" required>
                        <small class="text-muted">Enter the current market exchange rate at time of receipt</small>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> Once approved, the Money Received will be calculated as:<br>
                        <code>Money Received = Money in EURO × Market Exchange Rate</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Approve Receipt</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Approve All Items Modal (Secretary) -->
<div class="modal fade" id="approveAllModal" tabindex="-1" aria-labelledby="approveAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveAllModalLabel">Approve All Courier Items</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveAllForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="market_exchange_rate_all" class="form-label">Market Exchange Rate (EUR to AED)</label>
                        <input type="number" step="0.0001" class="form-control" id="market_exchange_rate_all" placeholder="e.g., 4.1000" required>
                        <small class="text-muted">Enter the current market exchange rate - will be applied to all unapproved items</small>
                    </div>
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will approve all unapproved items at once using the same market exchange rate.
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> Money Received will be calculated as:<br>
                        <code>Money Received = Money in EURO × Market Exchange Rate</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Approve All Items</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const courierId = {{ courier.id }};

// Container clients data
const containerClients = {
    {% for container_num, clients in container_clients.items() %}
    "{{ container_num }}": [
        {% for mark, name in clients %}
        {"mark": "{{ mark }}", "name": "{{ name }}"},
        {% endfor %}
    ],
    {% endfor %}
};

// Initialize sender fields on page load
document.addEventListener('DOMContentLoaded', function() {
    const senderSelect = document.getElementById('sender_name_select');
    const senderInput = document.getElementById('sender_name_input');
    
    // By default, input is enabled, select is disabled
    senderInput.disabled = false;
    senderSelect.disabled = true;
});

// Update sender name dropdown based on selected container
function updateSenderOptions() {
    const containerSelect = document.getElementById('container_number');
    const senderSelect = document.getElementById('sender_name_select');
    const senderInput = document.getElementById('sender_name_input');
    const selectedContainer = containerSelect.value;
    
    if (selectedContainer && containerClients[selectedContainer]) {
        // Container selected - show dropdown
        const clients = containerClients[selectedContainer];
        if (clients.length > 0) {
            // Clear and populate dropdown
            senderSelect.innerHTML = '<option value="">-- Select Client Mark --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.mark;
                option.textContent = `${client.mark} (${client.name})`;
                senderSelect.appendChild(option);
            });
            
            // Show dropdown, hide input, disable input so it won't be submitted
            senderSelect.style.display = 'block';
            senderSelect.disabled = false;
            senderInput.style.display = 'none';
            senderInput.disabled = true;
            senderInput.value = '';
        } else {
            // No clients - show input
            senderSelect.style.display = 'none';
            senderSelect.disabled = true;
            senderInput.style.display = 'block';
            senderInput.disabled = false;
        }
    } else {
        // No container selected - show input for manual entry
        senderSelect.style.display = 'none';
        senderSelect.disabled = true;
        senderInput.style.display = 'block';
        senderInput.disabled = false;
    }
}

// Update sender name dropdown for edit modal
function updateEditSenderOptions() {
    const containerSelect = document.getElementById('edit_container_number');
    const senderSelect = document.getElementById('edit_sender_name_select');
    const senderInput = document.getElementById('edit_sender_name_input');
    const selectedContainer = containerSelect.value;
    
    if (selectedContainer && containerClients[selectedContainer]) {
        // Container selected - show dropdown
        const clients = containerClients[selectedContainer];
        if (clients.length > 0) {
            // Clear and populate dropdown
            senderSelect.innerHTML = '<option value="">-- Select Client Mark --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.mark;
                option.textContent = `${client.mark} (${client.name})`;
                senderSelect.appendChild(option);
            });
            
            // Show dropdown, hide input, disable input
            senderSelect.style.display = 'block';
            senderSelect.disabled = false;
            senderInput.style.display = 'none';
            senderInput.disabled = true;
        } else {
            // No clients - show input
            senderSelect.style.display = 'none';
            senderSelect.disabled = true;
            senderInput.style.display = 'block';
            senderInput.disabled = false;
        }
    } else {
        // No container selected - show input for manual entry
        senderSelect.style.display = 'none';
        senderSelect.disabled = true;
        senderInput.style.display = 'block';
        senderInput.disabled = false;
    }
}

// No longer needed - browser handles validation with disabled/enabled fields


// Edit item
document.addEventListener('click', function(event) {
    const editBtn = event.target.closest('.edit-item-btn');
    if (editBtn) {
        const itemId = editBtn.dataset.itemId;
        document.getElementById('edit_item_id').value = itemId;
        const containerNum = editBtn.dataset.container || '';
        document.getElementById('edit_container_number').value = containerNum;
        
        // Update sender options based on container
        if (containerNum) {
            updateEditSenderOptions();
        }
        
        // Then set the sender value
        setTimeout(() => {
            const senderName = editBtn.dataset.sender;
            const senderSelect = document.getElementById('edit_sender_name_select');
            const senderInput = document.getElementById('edit_sender_name_input');
            
            // Check which field is visible and set value accordingly
            if (senderSelect.style.display !== 'none') {
                // Dropdown is visible - set select value
                senderSelect.value = senderName;
            } else {
                // Input is visible - set input value
                senderInput.value = senderName;
            }
        }, 50);
        document.getElementById('edit_receiver_name').value = editBtn.dataset.receiver;
        document.getElementById('edit_amount').value = editBtn.dataset.amount;
        document.getElementById('edit_service').value = editBtn.dataset.service;
        document.getElementById('edit_exchange_rate').value = editBtn.dataset.rate;
        
        const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
        modal.show();
    }
    
    // Delete item
    const deleteBtn = event.target.closest('.delete-item-btn');
    if (deleteBtn) {
        const itemId = deleteBtn.dataset.itemId;
        if (confirm('Are you sure you want to delete this item?')) {
            fetch(`/courier/${courierId}/item/${itemId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error deleting item');
            });
        }
    }
});

// Handle approve all form submission
document.getElementById('approveAllForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('market_exchange_rate', document.getElementById('market_exchange_rate_all').value);
    
    fetch(`/courier/${courierId}/approve-all`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error approving items: ' + error);
    });
});

// Handle edit form submission
document.getElementById('editItemForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const itemId = document.getElementById('edit_item_id').value;
    const formData = new FormData();
    formData.append('container_number', document.getElementById('edit_container_number').value);
    
    // Get sender name from visible field (select or input)
    const senderSelect = document.getElementById('edit_sender_name_select');
    const senderInput = document.getElementById('edit_sender_name_input');
    const senderName = senderSelect.style.display !== 'none' ? senderSelect.value : senderInput.value;
    formData.append('sender_name', senderName);
    
    formData.append('receiver_name', document.getElementById('edit_receiver_name').value);
    formData.append('amount', document.getElementById('edit_amount').value);
    formData.append('service', document.getElementById('edit_service').value);
    formData.append('exchange_rate', document.getElementById('edit_exchange_rate').value);
    
    fetch(`/courier/${courierId}/item/${itemId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error updating item');
    });
});
</script>
{% endblock %}
