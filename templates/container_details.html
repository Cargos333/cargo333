{% extends "base.html" %}
{% block content %}
<div class="container">
    <h1>Container #{{ container.container_number }} Details</h1>
    <!-- App config: expose server-side constants safely via data- attributes -->
    <div id="app-config" data-tonne-to-m3="{{ container_tonne_to_m3 }}" data-container-price="{{ container.price }}" data-container-volume="{{ container.total_volume }}" style="display:none"></div>
    <!-- Server-side values exposed safely to JS via data- attributes -->
    <div id="server-data" data-container-number="{{ container.container_number }}" data-sur-et-start="{{ container.sur_et_start|tojson }}" style="display:none"></div>
    
    <!-- Container Information -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">Container Information</h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editContainerModal">Edit Container</button>
                </div>
            </div>
            {% if container.container_name %}
            <p>Name: {{ container.container_name }}</p>
            {% endif %}
            <p>Type: {{ container.container_type }}</p>
            <p>Total Volume: {{ container.total_volume }} m³</p>
            <p>Price: AED {{ container.price|format_number }}</p>
            <p>Destination: {{ container.destination }}</p>
            <p>Available Volume: {{ container.total_volume - container.shipments|sum(attribute='volume') }} m³</p>
        </div>
    </div>

    <!-- Edit Container Modal (top pop menu) -->
    <div class="modal fade" id="editContainerModal" tabindex="-1" aria-labelledby="editContainerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document" style="margin-top:40px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editContainerModalLabel">Edit Container #{{ container.container_number }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('edit_container', id=container.id) }}" method="POST">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Container Number</label>
                                <input type="text" name="container_number" class="form-control" value="{{ container.container_number }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Container Name</label>
                                <input type="text" name="container_name" class="form-control" value="{{ container.container_name or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Container Type</label>
                                <select name="container_type" class="form-select">
                                    <option value="20ft" {% if container.container_type == '20ft' %}selected{% endif %}>20ft</option>
                                    <option value="40ft" {% if container.container_type == '40ft' %}selected{% endif %}>40ft</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Destination</label>
                                <input type="text" name="destination" class="form-control" value="{{ container.destination or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total Volume (m³)</label>
                                <input type="number" step="0.01" name="total_volume" class="form-control" value="{{ container.total_volume }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Price (AED)</label>
                                <input type="number" step="0.01" name="price" class="form-control" value="{{ container.price }}" required>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sur_et_start" id="surEtStart" {% if container.sur_et_start %}checked{% endif %}>
                                    <label class="form-check-label" for="surEtStart">Mark as Sur ET STAR (High Priority)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Client Form -->
    {% if container.status != 'delivered' %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Add New Client to Container</h5>
        </div>
        <div class="card-body">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Excel Upload Form -->
            <form action="{{ url_for('upload_excel', id=container.id) }}" method="POST" 
                  enctype="multipart/form-data" class="mb-4">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="excel_file" class="form-label">
                            Upload Excel File 
                            <a href="{{ url_for('download_template') }}" class="btn btn-link btn-sm">
                                Download Template
                            </a>
                        </label>
                        <input type="file" class="form-control" id="excel_file" name="file" 
                               accept=".xlsx" required>
                        <small class="form-text text-muted">
                            Excel file should have columns: Client Mark, Client Name, Phone, Goods Type, Volume, Volume Used, Tonnage, Price / Tonne
                            <br>
                            - Goods Type: one of Merchandise, Car, Metals
                            <br>
                            - For Metals provide Tonnage (t) and Price / Tonne (AED) if available; for Car provide Volume (Vide) and optionally Volume Used
                        </small>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success">Upload and Process</button>
                    </div>
                </div>
            </form>
            <hr>
            <!-- Existing manual form -->
            <form action="{{ url_for('add_client_to_container', id=container.id) }}" method="POST">
                <div class="row mb-4">
                    <!-- Add this div above or within your client add form -->
                    <div class="col-12">
                        <div id="outstanding-payments-alert"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="client_mark" class="form-label">Client Mark</label>
                        <input type="text" class="form-control" id="client_mark" name="client_mark" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="client_name" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="client_name" name="client_name" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="client_phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="client_phone" name="client_phone">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="goods_type" class="form-label">Goods Type</label>
                        <select class="form-select" id="goods_type" name="goods_type" required onchange="onGoodsTypeChange()">
                            <option value="Merchandise">Merchandise</option>
                            <option value="Car">Car</option>
                            <option value="Metals">Metals</option>
                        </select>
                    </div>
                    <!-- Merchandise / Car computed volume -->
                    <div class="col-md-6 mb-3" id="volume_group">
                        <label for="volume" class="form-label">Volume (m³)</label>
                        <input type="number" step="0.01" class="form-control" id="volume" name="volume" required onchange="calculatePrice()">
                    </div>

                    <!-- Car specific inputs -->
                    <div class="col-md-6 mb-3 d-none" id="car_vide_group">
                        <label for="volume_vide" class="form-label">Volume Vide (m³)</label>
                        <input type="number" step="0.01" class="form-control" id="volume_vide" name="volume_vide" onchange="onCarVolumeChange()">
                    </div>
                    <div class="col-md-6 mb-3 d-none" id="car_used_group">
                        <label for="volume_used" class="form-label">Volume Used (m³)</label>
                        <input type="number" step="0.01" class="form-control" id="volume_used" name="volume_used" onchange="onCarVolumeChange()">
                    </div>

                    <!-- Metals specific inputs -->
                    <div class="col-md-6 mb-3 d-none" id="metals_tonnage_group">
                        <label for="tonnage" class="form-label">Tonnage (tonnes)</label>
                        <input type="number" step="0.01" class="form-control" id="tonnage" name="tonnage" onchange="onMetalsChange()">
                    </div>
                    <div class="col-md-6 mb-3 d-none" id="metals_price_group">
                        <label for="price_per_tonne" class="form-label">Price per Tonne (AED)</label>
                        <input type="number" step="0.01" class="form-control" id="price_per_tonne" name="price_per_tonne" onchange="onMetalsChange()">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="price" name="price" required readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="extra_charge" class="form-label">Extra Charge</label>
                        <input type="number" step="0.01" class="form-control" id="extra_charge" name="extra_charge" value="0" onchange="calculatePrice()" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="payment_status" class="form-label">Payment Status</label>
                        <select class="form-select" id="payment_status" name="payment_status" required onchange="togglePartialPayment(this)">
                            <option value="paid">Paid</option>
                            <option value="unpaid" selected>Unpaid</option>
                            <option value="partial">Partial</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3" id="partial_payment_div" style="display: none;">
                        <label for="paid_amount" class="form-label">Paid Amount</label>
                        <input type="number" step="0.01" class="form-control" id="paid_amount" name="paid_amount">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Client</button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Client List -->
    <h2>Clients in Container</h2>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Mark</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Tonnage (t)</th>
                    <th class="col-editable-header" style="display:none">Volume Vide (m³)</th>
                    <th class="col-editable-header" style="display:none">Volume Used (m³)</th>
                    <th>Volume (m³)</th>
                    <th>Price (AED)</th>
                    <th>Extra Charge</th>
                    <th>Total</th>
                    <th>Payment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for shipment in container.shipments %}
                {% set client = shipment.client %}
                <tr data-client-mark="{{ client.mark if client else '' }}" data-shipment-id="{{ shipment.id }}">
                    <td>{{ loop.index }}</td>
                    <td>
                        {% if client %}
                                <a href="{{ url_for('client_products', id=client.id, container_id=container.id) }}" 
                                    title="View {{ client.mark }}'s products" class="client-mark-link">
                            {{ client.mark }}
                        </a>
                        {% else %}
                        <span class="text-muted">Client #{{ shipment.client_id }}</span>
                        {% endif %}
                        <span class="outstanding-badge badge bg-danger d-none" 
                              data-bs-toggle="tooltip" data-bs-placement="top">
                            <i class="fas fa-exclamation-circle"></i>
                        </span>
                    </td>
                    <td>{{ client.name if client else 'Unknown' }}</td>
                    <td>
                        <span class="view-mode">{{ client.phone if client else '' }}</span>
                        <input type="text" class="form-control edit-mode d-none" name="client_phone" value="{{ client.phone if client else '' }}">
                    </td>
                    <td>
                        <span class="view-mode">{% if shipment.tonnage is not none %}{{ shipment.tonnage }}{% endif %}</span>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="tonnage" value="{% if shipment.tonnage is not none %}{{ shipment.tonnage }}{% else %}{% endif %}">
                    </td>
                    <td class="col-editable-cell" style="display:none">
                        <span class="view-mode"><!-- hidden by default, shown only in edit mode --></span>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="volume_vide" value="{% if shipment.volume_vide is not none %}{{ shipment.volume_vide }}{% else %}{% endif %}">
                    </td>
                    <td class="col-editable-cell" style="display:none">
                        <span class="view-mode"><!-- hidden by default, shown only in edit mode --></span>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="volume_used" value="{% if shipment.volume_used is not none %}{{ shipment.volume_used }}{% else %}{% endif %}">
                    </td>
                    <td>
                        <span class="view-mode">{% if shipment.tonnage is none %}{{ shipment.volume }}{% else %}{% endif %}</span>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="volume" value="{{ shipment.volume }}" onchange="recalculatePrice(this)">
                    </td>
                    <td>
                        <span class="view-mode">{{ shipment.price|format_number }} AED</span>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="price" value="{{ shipment.price }}" readonly>
                        <!-- price_per_tonne for metals (edit only) -->
                        <input type="number" step="0.01" class="form-control edit-mode d-none mt-1" name="price_per_tonne" value="{% if shipment.price_per_tonne is not none %}{{ shipment.price_per_tonne }}{% else %}{% endif %}" placeholder="Price per tonne">
                    </td>
                    <td>
                        <span class="view-mode">{{ shipment.extra_charge|format_number }} AED</span>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="extra_charge" value="{{ shipment.extra_charge }}">
                    </td>
                    <td>
                        <span class="view-mode">
                            {% if shipment.payment_status == 'partial' %}
                                {{ shipment.paid_amount|format_number }} AED
                            {% else %}
                                {{ (shipment.price + shipment.extra_charge)|format_number }} AED
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="view-mode">{{ shipment.payment_status }}</span>
                        <select class="form-select edit-mode d-none" name="payment_status" onchange="toggleEditPartialInput(this)">
                            <option value="paid" {% if shipment.payment_status == 'paid' %}selected{% endif %}>Paid</option>
                            <option value="unpaid" {% if shipment.payment_status == 'unpaid' %}selected{% endif %}>Unpaid</option>
                            <option value="partial" {% if shipment.payment_status == 'partial' %}selected{% endif %}>Partial</option>
                        </select>
                        <input type="number" step="0.01" class="form-control edit-mode d-none" name="paid_amount" value="{{ shipment.paid_amount }}">
                    </td>
                    <td>
                        {% if container.status != 'delivered' %}
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary btn-sm view-mode btn-toggle-edit" data-shipment-id="{{ shipment.id }}">Edit</button>
                            <button type="button" class="btn btn-success btn-sm edit-mode d-none btn-save-shipment" data-shipment-id="{{ shipment.id }}">Save</button>
                            <button type="button" class="btn btn-secondary btn-sm edit-mode d-none btn-cancel-shipment" data-shipment-id="{{ shipment.id }}">Cancel</button>
                            <form action="{{ url_for('delete_shipment', id=shipment.id) }}" method="POST" 
                                  onsubmit="return confirm('Are you sure you want to delete this client from the container?');" class="d-inline">
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                            {% if current_user.role == 'Admin' or current_user.role == 'Secretary' %}
                            <div class="btn-group">
                                <button type="button" class="btn btn-success btn-sm btn-print-client" data-shipment-id="{{ shipment.id }}" data-currency="aed">
                                    <i class="fas fa-print"></i> AED
                                </button>
                                {% if current_user.role == 'Admin' %}
                                <button type="button" class="btn btn-info btn-sm btn-print-client" data-shipment-id="{{ shipment.id }}" data-currency="eur">
                                    <i class="fas fa-print"></i> EUR
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if shipment.client.phone %}
                            <a href="https://wa.me/{{ shipment.client.phone|replace(' ', '')|replace('+', '') }}" 
                               target="_blank" class="btn btn-sm" style="background-color: #25D366; color: white;">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Read server-provided config from hidden DOM element
const _appConfigEl = document.getElementById('app-config');
const _tonneToM3_from_config = _appConfigEl ? parseFloat(_appConfigEl.dataset.tonneToM3) || 1 : 1;
const _containerPrice_from_config = _appConfigEl ? parseFloat(_appConfigEl.dataset.containerPrice) || 0 : 0;
const _containerVolume_from_config = _appConfigEl ? parseFloat(_appConfigEl.dataset.containerVolume) || 0.001 : 0.001;
// Handle goods type selection and show/hide appropriate inputs
function onGoodsTypeChange() {
    const goodsType = document.getElementById('goods_type').value;
    const volumeGroup = document.getElementById('volume_group');
    const carVide = document.getElementById('car_vide_group');
    const carUsed = document.getElementById('car_used_group');
    const metalsTonnage = document.getElementById('metals_tonnage_group');
    const metalsPrice = document.getElementById('metals_price_group');

    if (goodsType === 'Merchandise') {
        volumeGroup.classList.remove('d-none');
        // Allow manual editing of volume for Merchandise
        const volInput = document.getElementById('volume');
        if (volInput) { volInput.readOnly = false; volInput.removeAttribute('readonly'); volInput.required = true; }
        // Clear/disable fields not needed for Merchandise
        const tonnageInput = document.getElementById('tonnage');
        const pptInput = document.getElementById('price_per_tonne');
        if (tonnageInput) { tonnageInput.required = false; }
        if (pptInput) { pptInput.required = false; }
        const videInput = document.getElementById('volume_vide');
        const usedInput = document.getElementById('volume_used');
        if (videInput) { videInput.required = false; }
        if (usedInput) { usedInput.required = false; }
        carVide.classList.add('d-none');
        carUsed.classList.add('d-none');
        metalsTonnage.classList.add('d-none');
        metalsPrice.classList.add('d-none');
    } else if (goodsType === 'Car') {
        volumeGroup.classList.remove('d-none');
        const volInput = document.getElementById('volume');
        if (volInput) { volInput.readOnly = true; volInput.required = true; }
        carVide.classList.remove('d-none');
        carUsed.classList.remove('d-none');
        // Require vide/used for car calculation
        const videInput = document.getElementById('volume_vide');
        const usedInput = document.getElementById('volume_used');
        if (videInput) { videInput.required = true; }
        if (usedInput) { usedInput.required = true; }
        metalsTonnage.classList.add('d-none');
        metalsPrice.classList.add('d-none');
    } else if (goodsType === 'Metals') {
        volumeGroup.classList.remove('d-none');
        const volInput2 = document.getElementById('volume');
        if (volInput2) { volInput2.readOnly = true; volInput2.required = true; }
        carVide.classList.add('d-none');
        carUsed.classList.add('d-none');
        metalsTonnage.classList.remove('d-none');
        metalsPrice.classList.remove('d-none');
        // Require metals inputs
        const tonnageInput2 = document.getElementById('tonnage');
        const pptInput2 = document.getElementById('price_per_tonne');
        if (tonnageInput2) { tonnageInput2.required = true; }
        if (pptInput2) { pptInput2.required = true; }
    }
    calculatePrice();
}

function onCarVolumeChange() {
    const vide = parseFloat(document.getElementById('volume_vide').value) || 0;
    const used = parseFloat(document.getElementById('volume_used').value) || 0;
    const vol = Math.max(vide - used, 0);
    document.getElementById('volume').value = vol.toFixed(2);
    calculatePrice();
}

function onMetalsChange() {
    const tonnage = parseFloat(document.getElementById('tonnage').value) || 0;
    const pricePerTonne = parseFloat(document.getElementById('price_per_tonne').value) || 0;
    // Use server-side TONNE_TO_M3 for conversion; embed via template variable if available
    const tonneToM3 = _tonneToM3_from_config;
    const vol = tonnage * tonneToM3;
    document.getElementById('volume').value = vol.toFixed(2);
    // Price is tonnage * pricePerTonne
    const metalsPrice = Math.round(tonnage * pricePerTonne);
    document.getElementById('price').value = metalsPrice;
    console.debug('onMetalsChange:', { tonnage, pricePerTonne, tonneToM3, vol, metalsPrice });
}
function togglePartialPayment(select) {
    const partialDiv = document.getElementById('partial_payment_div');
    partialDiv.style.display = select.value === 'partial' ? 'block' : 'none';
}

function togglePartialInput(select) {
    const input = select.nextElementSibling;
    input.style.display = select.value === 'partial' ? 'inline' : 'none';
}

document.getElementById('client_mark').addEventListener('blur', function() {
    const mark = this.value;
    if (mark) {
        fetch(`/client/get_by_mark/${mark}`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('client_name').value = data.name;
                    document.getElementById('client_phone').value = data.phone;
                }
            });
    }
});

/**
 * Calculate client price based on container price and volume
 * This matches the back-end calculation for consistency
 */
function calculateClientPrice(containerPrice, containerVolume, clientVolume, extraCharge = 0) {
    // Ensure all values are numbers and avoid division by zero
    containerPrice = parseFloat(containerPrice) || 0;
    containerVolume = Math.max(parseFloat(containerVolume) || 0.001, 0.001); // Avoid division by zero
    clientVolume = parseFloat(clientVolume) || 0;
    extraCharge = parseFloat(extraCharge) || 0;
    
    // Calculate base price using the proportion of volume
    const basePrice = Math.round((containerPrice / containerVolume) * clientVolume);
    
    // Add extra charge to get total price
    const totalPrice = basePrice + extraCharge;
    
    return {
        basePrice: basePrice,
        totalPrice: Math.round(totalPrice)
    };
}

function calculatePrice() {
    const goodsType = document.getElementById('goods_type') ? document.getElementById('goods_type').value : 'Merchandise';
    const extraCharge = parseFloat(document.getElementById('extra_charge').value) || 0;

    if (goodsType === 'Metals') {
        // For metals, use tonnage and price per tonne
        const tonnage = parseFloat(document.getElementById('tonnage').value) || 0;
        const pricePerTonne = parseFloat(document.getElementById('price_per_tonne').value) || 0;
        const metalsPrice = Math.round(tonnage * pricePerTonne);
        const tonneToM3 = _tonneToM3_from_config;
        const vol = tonnage * tonneToM3;
        document.getElementById('volume').value = vol.toFixed(2);
        document.getElementById('price').value = metalsPrice;
        console.debug('calculatePrice (Metals):', { tonnage, pricePerTonne, tonneToM3, vol, metalsPrice, extraCharge });
        return;
    }

    // Car: compute volume from vide and used, then use proportional pricing
    if (goodsType === 'Car') {
        const vide = parseFloat(document.getElementById('volume_vide').value) || 0;
        const used = parseFloat(document.getElementById('volume_used').value) || 0;
        const clientVolume = Math.max(vide - used, 0);
        document.getElementById('volume').value = clientVolume.toFixed(2);
        const containerPrice = _containerPrice_from_config;
        const containerVolume = _containerVolume_from_config;
        const result = calculateClientPrice(containerPrice, containerVolume, clientVolume, extraCharge);
        document.getElementById('price').value = result.basePrice;
        console.debug('calculatePrice (Car):', { vide, used, clientVolume, result });
        return;
    }

    // Default: Merchandise (proportional by volume)
    const containerPrice = _containerPrice_from_config;
    const containerVolume = _containerVolume_from_config;
    const clientVolume = parseFloat(document.getElementById('volume').value) || 0;
    const result = calculateClientPrice(containerPrice, containerVolume, clientVolume, extraCharge);
    document.getElementById('price').value = result.basePrice;
}

function recalculatePrice(volumeInput) {
    const containerPrice = _containerPrice_from_config;
    const containerVolume = _containerVolume_from_config;
    const clientVolume = parseFloat(volumeInput.value) || 0;
    const row = volumeInput.closest('tr');
    const priceInput = row.querySelector('input[name="price"]');
    const extraChargeInput = row.querySelector('input[name="extra_charge"]');
    
    const result = calculateClientPrice(containerPrice, containerVolume, clientVolume);
    priceInput.value = result.basePrice;
}

function toggleEditMode(shipmentId) {
    const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
    const viewElements = row.querySelectorAll('.view-mode');
    const editElements = row.querySelectorAll('.edit-mode');
    
    viewElements.forEach(el => el.classList.toggle('d-none'));
    editElements.forEach(el => el.classList.toggle('d-none'));

    // Show or hide the editable column headers (Volume Vide / Volume Used)
    const anyEditing = document.querySelector('.edit-mode:not(.d-none)') !== null;
    document.querySelectorAll('.col-editable-header').forEach(h => {
        h.style.display = anyEditing ? '' : 'none';
    });

    // Show or hide the editable cells for THIS ROW only
    const editableCells = row.querySelectorAll('.col-editable-cell');
    const rowIsEditing = row.querySelector('.edit-mode:not(.d-none)') !== null;
    editableCells.forEach(cell => {
        cell.style.display = rowIsEditing ? '' : 'none';
    });
    // Add a class to expand the row visually when editing so inputs are easier to see
    if (rowIsEditing) {
        row.classList.add('editing-row');
        // scroll the row to center of viewport so user sees the expanded inputs
        setTimeout(() => {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Focus the first editable input and give it extra min-width so user can edit comfortably
            const firstInput = row.querySelector('.edit-mode input, .edit-mode select, .edit-mode textarea');
            if (firstInput) {
                try { firstInput.focus({ preventScroll: true }); } catch(e) { firstInput.focus(); }
                // give the focused input more horizontal room (user can slide to see full length)
                firstInput.style.minWidth = '480px';

                // Ensure the table container scrolls horizontally so the focused input is visible
                const tableContainer = row.closest('.table-responsive');
                if (tableContainer) {
                    const inputRect = firstInput.getBoundingClientRect();
                    const containerRect = tableContainer.getBoundingClientRect();
                    const offset = (inputRect.left - containerRect.left) - (containerRect.width / 4);
                    tableContainer.scrollBy({ left: offset, behavior: 'smooth' });
                }
            }
        }, 120);
    } else {
        row.classList.remove('editing-row');
    }

    // When leaving edit mode, remove any temporary minWidth we added
    if (!rowIsEditing) {
        const editedInputs = row.querySelectorAll('.edit-mode input, .edit-mode select, .edit-mode textarea');
        editedInputs.forEach(i => { i.style.minWidth = ''; i.blur && i.blur(); });
    }

    // When entering edit mode, ensure the paid_amount input visibility matches the payment_status select
    if (rowIsEditing) {
        const paymentSelect = row.querySelector('select[name="payment_status"]');
        if (paymentSelect && typeof toggleEditPartialInput === 'function') {
            // ensure paid_amount input visibility is correct
            toggleEditPartialInput(paymentSelect);
        }
    }
}

function saveShipment(shipmentId) {
    const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
    if (!row) {
        console.error('Row not found');
        return;
    }

    try {
        const formData = new FormData();
        
        // Extract all form fields from the row
        const clientName = row.querySelector('td:nth-child(3)').textContent.trim();
        const clientMark = row.querySelector('td:nth-child(2) a.client-mark-link').textContent.trim();
        const clientPhone = row.querySelector('input[name="client_phone"]').value;
    const volume = row.querySelector('input[name="volume"]').value;
    const price = row.querySelector('input[name="price"]').value;
    const tonnage = row.querySelector('input[name="tonnage"]') ? row.querySelector('input[name="tonnage"]').value : '';
    const pricePerTonne = row.querySelector('input[name="price_per_tonne"]') ? row.querySelector('input[name="price_per_tonne"]').value : '';
    const volumeVide = row.querySelector('input[name="volume_vide"]') ? row.querySelector('input[name="volume_vide"]').value : '';
    const volumeUsed = row.querySelector('input[name="volume_used"]') ? row.querySelector('input[name="volume_used"]').value : '';
        const extraCharge = row.querySelector('input[name="extra_charge"]').value;
        const paymentStatus = row.querySelector('select[name="payment_status"]').value;
        const paidAmount = row.querySelector('input[name="paid_amount"]').value;
        
        // Add all fields to formData
    formData.append('client_name', clientName);
    formData.append('client_mark', clientMark);
    formData.append('client_phone', clientPhone);
    formData.append('volume', volume);
    formData.append('tonnage', tonnage);
    formData.append('price_per_tonne', pricePerTonne);
    formData.append('volume_vide', volumeVide);
    formData.append('volume_used', volumeUsed);
    formData.append('price', price);
    formData.append('extra_charge', extraCharge || 0);
    formData.append('payment_status', paymentStatus);
    formData.append('paid_amount', paidAmount || 0);
        
        // Debug data being sent
        console.log('Submitting shipment update with data:', {
            shipmentId,
            clientName,
            clientMark,
            clientPhone,
            volume,
            price,
            extraCharge,
            paymentStatus,
            paidAmount
        });
        
        // Send the data to the server
        fetch(`/shipment/${shipmentId}/edit`, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || response.statusText);
                }).catch(e => {
                    throw new Error(response.statusText);
                });
            }
            return response.text();
        }).then(data => {
            // Success - reload the page to show updated data
            window.location.reload();
        }).catch(error => {
            console.error('Error updating shipment:', error);
            alert(`Error updating client: ${error.message}`);
            
            // Return the row to view mode
            toggleEditMode(shipmentId);
        });
    } catch (e) {
        console.error('Exception in saveShipment:', e);
        alert(`Error processing form data: ${e.message}`);
        
        // Return the row to view mode
        toggleEditMode(shipmentId);
    }
}

function updateTotalPrice(extraChargeInput) {
    const row = extraChargeInput.closest('tr');
    const basePriceInput = row.querySelector('input[name="base_price"]');
    const totalPriceInput = row.querySelector('input[name="price"]');
    
    const basePrice = Math.round(parseFloat(basePriceInput.value)) || 0;
    const extraCharge = Math.round(parseFloat(extraChargeInput.value)) || 0;
    
    const totalPrice = basePrice + extraCharge;
    totalPriceInput.value = totalPrice;
}

function toggleEditPartialInput(select) {
    const row = select.closest('tr');
    const paidAmountInput = row.querySelector('input[name="paid_amount"]');
    paidAmountInput.style.display = select.value === 'partial' ? 'block' : 'none';
    
    if (select.value === 'paid') {
        const priceInput = row.querySelector('input[name="price"]');
        paidAmountInput.value = priceInput.value;
    } else if (select.value === 'unpaid') {
        paidAmountInput.value = '0';
    }
}

function printClientRow(shipmentId, currency = 'aed') {
    const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
    if (!row) {
        console.error('Row not found for shipment ID:', shipmentId);
        return;
    }

    // Fetch shipment + product breakdown from server API
    fetch(`/api/shipment-products/${shipmentId}`)
        .then(r => {
            // If we get a non-2xx response, surface status + body for debugging
            if (!r.ok) {
                return r.text().then(text => {
                    throw new Error(`Server returned ${r.status} ${r.statusText}: ${text}`);
                });
            }

            // Ensure the response is JSON before parsing
            const contentType = r.headers.get('content-type') || '';
            if (contentType.indexOf('application/json') === -1) {
                return r.text().then(text => {
                    throw new Error(`Expected JSON response but received: ${text}`);
                });
            }

            return r.json();
        })
        .then(data => {
            if (data.error) {
                alert('Could not load invoice details');
                console.error(data.error);
                return;
            }

            // Read fallback server values from hidden DOM element to avoid embedding Jinja in JS
            const _serverDataEl = document.getElementById('server-data');
            const containerNumber = data.container_number || (_serverDataEl ? _serverDataEl.dataset.containerNumber : '');
            const isSurEtStart = _serverDataEl ? (_serverDataEl.dataset.surEtStart === 'true' || _serverDataEl.dataset.surEtStart === 'True') : false;
            const statusText = isSurEtStart ? 'Sur ET STAR' : 'Normal Priority';

            const clientMark = data.client_mark || '';
            const clientName = data.client_name || '';
            // phone from row (client phone displayed in table)
            const clientPhone = row.querySelector('td:nth-child(4) .view-mode').textContent.trim();

            const shipmentPrice = parseFloat(data.shipment_price || 0);
            const extraCharge = parseFloat(data.extra_charge || 0);
            const paymentStatus = data.payment_status || '';
            const paidAmountVal = parseFloat(data.paid_amount || 0);

            // Group products by goods_type
            const groups = {};
            data.products.forEach(p => {
                const gt = p.goods_type || 'Merchandise';
                if (!groups[gt]) groups[gt] = [];
                groups[gt].push(p);
            });

            // Money conversion helper - keep same formula used below for final total
            const toEUR = (amount) => Math.round((parseFloat(amount) || 0) * 132 / 500);
            const convertForCurrency = (amount) => {
                if (currency && currency.toLowerCase() === 'eur') return toEUR(amount);
                return Math.round(parseFloat(amount) || 0);
            };

            // Build products HTML (categorized)
            let productsHtml = '';
            let productsTotal = 0;
            Object.keys(groups).forEach(cat => {
                productsHtml += `<h4 style="margin-top:16px">${cat}</h4>`;
                productsHtml += `
                    <table>
                        <thead>
                            <tr>
                                <th>Ref</th>
                                <th>Type</th>
                                <th>Volume Vide (m³)</th>
                                <th>Volume Used (m³)</th>
                                <th>Qty / Tonnage</th>
                                <th>Volume (m³)</th>
                                <th>Price (${currency.toUpperCase()})</th>
                            </tr>
                        </thead>
                        <tbody>`;

                groups[cat].forEach(p => {
                    const qtyOrT = p.goods_type === 'Metals' ? (p.tonnage || '') : (p.quantity != null ? p.quantity : '');
                    const volVide = p.volume_vide != null ? (p.volume_vide !== '' ? p.volume_vide : '') : '';
                    const volUsed = p.volume_used != null ? (p.volume_used !== '' ? p.volume_used : '') : '';
                    const vol = (p.goods_type === 'Metals') ? (p.volume ? p.volume : '') : (p.volume ? p.volume : '');
                    const priceRowRaw = parseFloat(p.allocated_price || 0);
                    const priceRow = convertForCurrency(priceRowRaw);
                    productsTotal += priceRow;

                    productsHtml += `
                        <tr>
                            <td>${p.reference || ''}</td>
                            <td>${p.goods_type || ''}</td>
                            <td>${volVide !== null && volVide !== '' ? Number(volVide).toFixed(2) : '&nbsp;'}</td>
                            <td>${volUsed !== null && volUsed !== '' ? Number(volUsed).toFixed(2) : '&nbsp;'}</td>
                            <td>${qtyOrT !== null && qtyOrT !== '' ? (p.goods_type === 'Metals' ? Number(qtyOrT).toFixed(2) : qtyOrT) : '&nbsp;'}</td>
                            <td>${vol !== null && vol !== '' ? Number(vol).toFixed(2) : '&nbsp;'}</td>
                            <td>${Number(priceRow).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        </tr>`;
                });

                productsHtml += `</tbody></table>`;
            });

            // Compute totals and format currency (convert shipment/extra/paid to target currency)
            const productsTotalFormatted = Number(productsTotal).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

            // Compute total volumes (m3), total volume_vide/used and total tonnage for Metals
            let totalVolume = 0;
            let totalTonnage = 0;
            let totalVolumeVide = 0;
            let totalVolumeUsed = 0;
            data.products.forEach(p => {
                const vol = parseFloat(p.volume || 0) || 0;
                totalVolume += vol;
                const t = parseFloat(p.tonnage || 0) || 0;
                totalTonnage += t;
                const vide = parseFloat(p.volume_vide || 0) || 0;
                totalVolumeVide += vide;
                const used = parseFloat(p.volume_used || 0) || 0;
                totalVolumeUsed += used;
            });
            const totalVolumeFormatted = Number(totalVolume).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            const totalTonnageFormatted = Number(totalTonnage).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            const totalVolumeVideFormatted = Number(totalVolumeVide).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            const totalVolumeUsedFormatted = Number(totalVolumeUsed).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

            const shipmentPriceDisplayVal = convertForCurrency(shipmentPrice);
            const extraChargeDisplayVal = convertForCurrency(extraCharge);
            const shipmentTotal = shipmentPriceDisplayVal + extraChargeDisplayVal;
            let finalTotal = shipmentTotal;
            const currencySymbol = (currency && currency.toLowerCase() === 'eur') ? 'EUR' : 'AED';

            const formattedFullTotal = `${finalTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} ${currencySymbol}`;

            const isPaid = paymentStatus.trim() === 'paid';
            const isPartial = paymentStatus.trim() === 'partial';
            let paidAmount = '';
            let remainingAmount = '';
            if (isPartial) {
                let paid = convertForCurrency(paidAmountVal || 0);
                paidAmount = `${paid.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} ${currencySymbol}`;
                remainingAmount = `${(finalTotal - paid).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} ${currencySymbol}`;
            }

            // Build and open print window with products details included
            // Summary block showing total volume, volume vide/used and (if any) total tonnage
            const totalsSummaryHtml = `
                <div style="margin-top:8px;margin-bottom:12px;font-size:14px;">
                    <table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Volume Vide (m³)</th>
                                <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Volume Used (m³)</th>
                                <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Volume (m³)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:6px;">${totalVolumeVideFormatted}</td>
                                <td style="padding:6px;">${totalVolumeUsedFormatted}</td>
                                <td style="padding:6px;">${totalVolumeFormatted}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${totalTonnage > 0 ? `<div style="margin-top:8px">Total Tonnage (t): <strong>${totalTonnageFormatted}</strong></div>` : ''}
                </div>`;
            const printWindow = window.open('', '', 'height=800,width=900');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${clientMark} - Invoice</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; color: #333; line-height: 1.6; }
                            .invoice { max-width: 800px; margin: 0 auto; background: #fff; border: 1px solid #ddd; padding: 30px; }
                            .header { border-bottom: 2px solid #2c3e50; padding-bottom: 20px; margin-bottom: 20px; }
                            .header h2 { color: #2c3e50; margin: 0 0 10px 0; font-size: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 13px; }
                            th { background-color: #2c3e50; color: white; padding: 8px; text-align: left; }
                            td { padding: 8px; border-bottom: 1px solid #ddd; }

                            /* Contacts / footer styling for printed invoice */
                            .contacts { margin-top:30px; font-size:13px; color:#444; border-top:1px solid #e6e6e6; padding-top:18px; }
                            .contacts .columns { display:flex; gap: 28px; flex-wrap:wrap; }
                            .contact { flex:1; min-width:220px; }
                            .contact h4 { margin:0 0 6px 0; font-size:13px; color:#2c3e50; }
                            .contact p { margin:4px 0; }
                            .agency { margin-top:12px; }

                            /* Header enhancements: status badge and client info box */
                            .header-row { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; }
                            .header-left { display:flex; flex-direction:column; }
                            .status-badge { display:inline-block; padding:6px 10px; border-radius:6px; color:white; font-weight:700; font-size:13px; margin-top:8px; }
                            .status-danger { background: #c82333; }
                            .status-normal { background: #198754; }
                            .client-info { background:#f8f9fa; border:1px solid #e9ecef; padding:10px 12px; border-radius:6px; min-width:240px; }
                            .client-info p { margin:4px 0; font-size:14px; }
                            .client-info .label { color:#555; font-weight:600; margin-right:6px; }
                        </style>
                    </head>
                    <body>
                        ${isPaid ? '<div style="position:absolute;top:15%;right:10%;transform:rotate(-30deg);color:rgba(220,53,69,0.7);font-size:24px;font-weight:bold;border:3px solid rgba(220,53,69,0.7);padding:5px 10px;border-radius:8px;">CARGO 333 PAID</div>' : ''}
                        <div class="header">
                            <div class="header-row">
                                <div class="header-left">
                                    <h2>Container #${containerNumber}</h2>
                                    <span class="status-badge ${isSurEtStart ? 'status-danger' : 'status-normal'}">${statusText}</span>
                                </div>
                                <div class="client-info">
                                    <p><span class="label">Client Name:</span> ${clientName}</p>
                                    <p><span class="label">Mark:</span> ${clientMark}</p>
                                    <p><span class="label">Phone:</span> ${clientPhone}</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3>Products</h3>
                            ${productsHtml}
                            ${totalsSummaryHtml}
                        </div>

                        <table>
                            <tr>
                                    <th style="text-align:right">Products Total (${currencySymbol})</th>
                                    <td style="width:200px;text-align:right">${productsTotalFormatted} ${currencySymbol}</td>
                                </tr>
                                <tr>
                                    <th style="text-align:right">Shipment Price</th>
                                    <td style="text-align:right">${Number(shipmentPriceDisplayVal).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})} ${currencySymbol}</td>
                                </tr>
                                <tr>
                                    <th style="text-align:right">Extra Charge</th>
                                    <td style="text-align:right">${Number(extraChargeDisplayVal).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})} ${currencySymbol}</td>
                                </tr>
                            <tr>
                                <th style="text-align:right"><strong>Total</strong></th>
                                <td style="text-align:right"><strong>${formattedFullTotal}</strong></td>
                            </tr>
                        </table>

                        ${isPartial ? `<div style="margin-top:12px;border:1px solid #ddd;padding:10px;background:#f9f9f9;">` +
                            `<strong>Payment Details:</strong><br/>Paid: ${paidAmount}<br/>Remaining: ${remainingAmount}</div>` : ''}

                        <div class="contacts">
                            <div class="columns">
                                <div class="contact">
                                    <h4>Information in Dubai</h4>
                                    <p><strong>PAPA LALY</strong>: +971 55 309 9610</p>
                                    <p><strong>AHMED</strong>: +971 55 215 4173</p>
                                </div>
                                <div class="contact">
                                    <h4>Information in Comoros</h4>
                                    <p><strong>MOHAMED ABDALLAH</strong>: 492 40 19 / 342 40 19</p>
                                </div>
                                <div class="contact agency">
                                    <h4>Agence in Comoros</h4>
                                    <p><strong>AGENCE ALVARO MORONI BACHA</strong></p>
                                    <p>Tel: 338 91 61</p>
                                </div>
                            </div>
                        </div>
                    </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 300);
        })
        .catch(err => {
            console.error('Failed to load shipment products:', err);
            alert('Failed to load products for invoice');
        });
}

// Modify the existing lookupClient function
function lookupClient() {
    const clientMark = document.getElementById('client_mark').value.trim();
    if (!clientMark) return;
    
    // Clear previous alerts
    document.getElementById('outstanding-payments-alert').innerHTML = '';
    
    // Always perform a fresh check for outstanding payments, bypassing any caching
    fetch(`/api/client-outstanding-payments/${encodeURIComponent(clientMark)}?timestamp=${Date.now()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.has_outstanding) {
                // Create alert message for outstanding payments
                const alertDiv = document.getElementById('outstanding-payments-alert');
                
                let alertHTML = `
                    <div class="alert alert-warning alert-dismissible fade show">
                        <h5><i class="fas fa-exclamation-triangle"></i> Outstanding Payments Found</h5>
                        <p>Client <strong>${data.client_name} (${data.client_mark})</strong> has unpaid amounts from previous deliveries.</p>
                        <p>Total outstanding: <strong>AED ${data.total_outstanding.toLocaleString()}</strong></p>
                        <button type="button" class="btn btn-warning btn-sm" onclick="addAsExtraCharge(${data.total_outstanding})">
                            <i class="fas fa-plus-circle"></i> Add as Extra Charge
                        </button>
                        <button type="button" class="btn btn-outline-dark btn-sm ms-2" data-bs-toggle="collapse" data-bs-target="#outstandingDetails">
                            <i class="fas fa-info-circle"></i> Show Details
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        
                        <div class="collapse mt-3" id="outstandingDetails">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Container</th>
                                            <th>Total Price</th>
                                            <th>Paid</th>
                                            <th>Outstanding</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                                    
                data.shipments.forEach(shipment => {
                    alertHTML += `
                        <tr>
                            <td>${shipment.container_number}</td>
                            <td>AED ${shipment.total_price.toLocaleString()}</td>
                            <td>AED ${shipment.paid.toLocaleString()}</td>
                            <td class="text-danger">AED ${shipment.outstanding.toLocaleString()}</td>
                        </tr>`;
                });
                
                alertHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                alertDiv.innerHTML = alertHTML;
            }
        })
        .catch(error => console.error('Error checking outstanding payments:', error));
    
    // Continue with the existing client lookup functionality
    fetch(`/client/get_by_mark/${encodeURIComponent(clientMark)}`)
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('client_name').value = data.name;
                document.getElementById('client_phone').value = data.phone || '';
            }
        })
        .catch(error => console.error('Error:', error));
}

// Fix the addAsExtraCharge function to properly handle the outstanding amount
function addAsExtraCharge(amount) {
    const extraChargeInput = document.getElementById('extra_charge');
    const clientMarkInput = document.getElementById('client_mark');
    
    // Make sure amount is treated as a number
    amount = parseFloat(amount);
    
    // If there's already a value, add to it
    let currentValue = parseFloat(extraChargeInput.value) || 0;
    
    // Set the exact amount from the outstanding balance
    // Instead of adding to any existing value, we're setting it directly
    // as the notification shows the total outstanding amount
    extraChargeInput.value = amount.toFixed(2);
    
    // Highlight the field briefly to draw attention
    extraChargeInput.classList.add('bg-warning');
    setTimeout(() => {
        extraChargeInput.classList.remove('bg-warning');
    }, 2000);
    
    // Update price calculation if that function exists
    if (typeof calculatePrice === 'function') {
        calculatePrice();
    }
    
    // Update the alert to indicate the amount has been added
    const alert = document.querySelector('#outstanding-payments-alert .alert');
    if (alert) {
        const addButton = alert.querySelector('.btn-warning');
        if (addButton) {
            addButton.innerHTML = '<i class="fas fa-check-circle"></i> Added to Extra Charge';
            addButton.classList.replace('btn-warning', 'btn-success');
            addButton.disabled = true;
        }
    }
    
    // Highlight the "Add Client" button to make it clear the user needs to submit the form
    const addClientButton = document.querySelector('form[action*="add-client"] button[type="submit"]');
    if (addClientButton) {
        addClientButton.classList.add('btn-lg', 'btn-pulse');
        addClientButton.innerHTML = '<i class="fas fa-arrow-right"></i> Click here to Add Client with Extra Charge';
        // Scroll to the button
        addClientButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Call API to mark outstanding payments as resolved
    const clientMark = clientMarkInput.value;
    if (clientMark) {
        const formData = new FormData();
        formData.append('client_mark', clientMark);
        formData.append('extra_charge', amount);  // Use the exact amount from parameter
        formData.append('resolve_outstanding', 'true');
        formData.append('new_client', 'true');
        
        // Add a loading indicator
        const loadingIndicator = document.createElement('span');
        loadingIndicator.innerHTML = ' <i class="fas fa-spinner fa-spin"></i> Resolving payments...';
        loadingIndicator.id = 'payment-loading-indicator';
        if (addButton) {
            addButton.after(loadingIndicator);
        }
        
        // Log the data being sent for debugging
        console.log('Resolving outstanding payment:', {
            client_mark: clientMark,
            extra_charge: amount,
            resolve_outstanding: true,
            new_client: true
        });
        
        fetch('/api/resolve-outstanding-payments', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Unknown error occurred');
                });
            }
            return response.json();
        }).then(data => {
            console.log('Outstanding payments marked as resolved:', data);
            
            // Remove loading indicator
            document.getElementById('payment-loading-indicator')?.remove();
            
            // Add success message
            if (data.shipments_updated > 0) {
                const successMsg = document.createElement('span');
                successMsg.innerHTML = ` <i class="fas fa-check"></i> ${data.shipments_updated} shipments marked as paid`;
                successMsg.className = 'text-success';
                if (addButton) {
                    addButton.after(successMsg);
                }
            }
        }).catch(error => {
            console.error('Error:', error);
            document.getElementById('payment-loading-indicator')?.remove();
            
            // Show error message
            const errorMsg = document.createElement('span');
            errorMsg.innerHTML = ` <i class="fas fa-exclamation-triangle"></i> ${error.message}`;
            errorMsg.className = 'text-danger';
            if (addButton) {
                addButton.after(errorMsg);
            }
        });
    }
}

// Make sure we call lookupClient when the input loses focus
document.getElementById('client_mark').addEventListener('blur', lookupClient);
// Also trigger on 'Enter' key press
document.getElementById('client_mark').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
        lookupClient();
    }
});

// Function to check outstanding payments for all clients in the table
function checkOutstandingPaymentsForTable() {
    // Get all client marks from the table
    const clientRows = document.querySelectorAll('tr[data-client-mark]');
    
    // First, reset all outstanding badges
    document.querySelectorAll('.outstanding-badge').forEach(badge => {
        badge.classList.add('d-none');
        badge.removeAttribute('data-outstanding');
        badge.removeAttribute('title');
        badge.classList.remove('clickable-badge');
        
        // Remove any existing event listeners
        const newBadge = badge.cloneNode(true);
        badge.parentNode.replaceChild(newBadge, badge);
    });
    
    // Process in batches to avoid too many simultaneous requests
    const processNextBatch = (startIndex, batchSize) => {
        const endIndex = Math.min(startIndex + batchSize, clientRows.length);
        const promises = [];
        
        for (let i = startIndex; i < endIndex; i++) {
            const row = clientRows[i];
            const clientMark = row.getAttribute('data-client-mark');
            const shipmentId = row.getAttribute('data-shipment-id');
            
            if (clientMark) {
                // Add a timestamp to prevent caching
                const promise = fetch(`/api/client-outstanding-payments/${encodeURIComponent(clientMark)}?timestamp=${Date.now()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.has_outstanding) {
                            // Show the outstanding badge
                            const badge = row.querySelector('.outstanding-badge');
                            if (badge) {
                                badge.classList.remove('d-none');
                                // Store the outstanding amount as a data attribute
                                badge.setAttribute('data-outstanding', data.total_outstanding);
                                // Change styling to make it obvious it's clickable
                                badge.classList.add('clickable-badge');
                                
                                // Set the badge to show the amount on hover using a normal title
                                badge.setAttribute('title', `Outstanding: AED ${data.total_outstanding.toLocaleString()} - Click to resolve`);
                                
                                // Set onclick handler with the correct parameters
                                badge.onclick = function(event) {
                                    // Prevent event propagation to avoid any parent click handlers
                                    event.stopPropagation();
                                    showResolveOutstandingModal(clientMark, data.total_outstanding, shipmentId);
                                };
                            }
                        }
                    })
                    .catch(error => console.error(`Error checking payments for ${clientMark}:`, error));
                
                promises.push(promise);
            }
        }
        
        // When all requests in this batch are done, process the next batch
        Promise.all(promises).then(() => {
            if (endIndex < clientRows.length) {
                // Process next batch after a short delay to avoid overwhelming the server
                setTimeout(() => processNextBatch(endIndex, batchSize), 200);
            }
        });
    };
    
    // Start processing in batches of 5
    processNextBatch(0, 5);
}

// Function to show modal for resolving outstanding payments
function showResolveOutstandingModal(clientMark, outstandingAmount, shipmentId) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('resolveOutstandingModal');
    if (!modal) {
        const modalHTML = `
            <div class="modal fade" id="resolveOutstandingModal" tabindex="-1" aria-labelledby="resolveOutstandingModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="resolveOutstandingModalLabel">Resolve Outstanding Payment</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Client <strong id="resolveClientMark"></strong> has outstanding payments of 
                               <strong id="resolveOutstandingAmount"></strong>.</p>
                            <p>How would you like to handle this?</p>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="resolveOption" id="addAsExtraCharge" value="extra_charge" checked>
                                <label class="form-check-label" for="addAsExtraCharge">
                                    Add as extra charge to current shipment
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="resolveOption" id="keepSeparate" value="keep_separate">
                                <label class="form-check-label" for="keepSeparate">
                                    Keep as separate outstanding payment
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="resolveConfirmBtn">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('resolveOutstandingModal');
    }
    
    // If outstandingAmount is 0, fetch it from the API
    if (outstandingAmount === 0) {
        fetch(`/api/client-outstanding-payments/${encodeURIComponent(clientMark)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.has_outstanding) {
                    setupModalContent(clientMark, data.total_outstanding, shipmentId);
                    const modalInstance = new bootstrap.Modal(modal);
                    modalInstance.show();
                }
            })
            .catch(error => {
                console.error('Error fetching outstanding amount:', error);
                alert('Could not fetch outstanding payment details');
            });
    } else {
        setupModalContent(clientMark, outstandingAmount, shipmentId);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    }
}

// Helper function to set up modal content
function setupModalContent(clientMark, outstandingAmount, shipmentId) {
    document.getElementById('resolveClientMark').textContent = clientMark;
    document.getElementById('resolveOutstandingAmount').textContent = `AED ${outstandingAmount.toLocaleString()}`;
    
    // Handle confirm button click
    document.getElementById('resolveConfirmBtn').onclick = function() {
        const option = document.querySelector('input[name="resolveOption"]:checked').value;
        
        if (option === 'extra_charge') {
            // Add to extra charge and mark as resolved in the system
            addOutstandingToExtraCharge(shipmentId, outstandingAmount, clientMark);
        } else {
            // Just close the modal - keep payments separate
            const modal = document.getElementById('resolveOutstandingModal');
            const modalInstance = bootstrap.Modal.getInstance(modal);
            modalInstance.hide();
        }
    };
}

// Add function to add outstanding amount to extra charge
function addOutstandingToExtraCharge(shipmentId, amount, clientMark) {
    const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
    if (!row) return;
    
    const extraChargeSpan = row.querySelector('td:nth-child(6) .view-mode');
    const extraChargeInput = row.querySelector('input[name="extra_charge"]');
    
    if (extraChargeSpan && extraChargeInput) {
        // Get current extra charge
        const currentExtraCharge = parseFloat(extraChargeSpan.textContent.replace('AED', '').replace(',', '').trim()) || 0;
        const newExtraCharge = currentExtraCharge + amount;
        
        // Update the extra charge input
        extraChargeInput.value = newExtraCharge;
        
        // Call server to update the shipment and resolve outstanding payments
        const formData = new FormData();
        formData.append('shipment_id', shipmentId);
        formData.append('extra_charge', newExtraCharge);
        formData.append('client_mark', clientMark);
        formData.append('resolve_outstanding', 'true');
        
        fetch('/api/resolve-outstanding-payments', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Unknown error occurred');
                });
            }
            return response.json();
        }).then(data => {
            if (data.success) {
                // Reload only the outstanding badges instead of the whole page
                reloadAfterResolving();
                
                // Show success message
                const alertHTML = `
                    <div class="alert alert-success alert-dismissible fade show">
                        <i class="fas fa-check-circle"></i> Added AED ${amount.toLocaleString()} to extra charge. Previous unpaid amounts marked as paid.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                const alertContainer = document.createElement('div');
                alertContainer.innerHTML = alertHTML;
                document.querySelector('.container').prepend(alertContainer.firstChild);
                
                // Hide the success message after 5 seconds
                setTimeout(() => {
                    const successAlert = document.querySelector('.alert-success');
                    if (successAlert) {
                        const bsAlert = new bootstrap.Alert(successAlert);
                        bsAlert.close();
                    }
                }, 5000);
                
            } else {
                alert('Error updating extra charge');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert(`Error updating extra charge: ${error.message}`);
        });
        
        // Close modal
        const modal = document.getElementById('resolveOutstandingModal');
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
    }
}

// Add CSS for the outstanding badge and improve table edit layout
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .outstanding-badge {
            margin-left: 5px;
        }
        .outstanding-badge i {
            font-size: 0.9rem;
        }
        .clickable-badge {
            cursor: pointer;
        }
        .clickable-badge:hover {
            opacity: 0.8;
            transform: scale(1.2);
        }
        .tooltip-inner {
            max-width: 300px;
            text-align: left;
        }
        
        .client-mark-link {
            text-decoration: none;
            color: #007bff;
            font-weight: 500;
        }
        
        .client-mark-link:hover {
            text-decoration: underline;
            color: #0056b3;
        }
        
        /* Pulse animation for "Add Client" button after adding extra charge */
        .btn-pulse {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        /* Ensure edit-mode inputs fit within their table cells */
        table.table td .form-control.edit-mode,
        table.table td .form-control.edit-mode:focus {
            width: 100% !important;
            box-sizing: border-box;
            min-width: 0; /* allow shrinking in fixed-layout cells */
        }

        /* Keep view-mode spans vertically aligned with inputs */
        table.table td .view-mode {
            display: block;
            min-height: 38px;
            padding-top: 6px;
        }

        /* Use percentage-based columns and wrapping to avoid horizontal scroll */
    /* Allow horizontal scrolling if needed so users can slide to see full content */
    .container > .table-responsive { overflow-x: auto; }
        table.table { width: 100%; table-layout: fixed; }
        /* Percent widths roughly matching prior layout but ensuring total <= 100% */
        table.table thead th:nth-child(1), table.table tbody td:nth-child(1) { width: 4%; }
        table.table thead th:nth-child(2), table.table tbody td:nth-child(2) { width: 8%; }
        table.table thead th:nth-child(3), table.table tbody td:nth-child(3) { width: 20%; }
        table.table thead th:nth-child(4), table.table tbody td:nth-child(4) { width: 10%; }
        table.table thead th:nth-child(5), table.table tbody td:nth-child(5) { width: 6%; }
        table.table thead th:nth-child(6), table.table tbody td:nth-child(6) { width: 7%; }
        table.table thead th:nth-child(7), table.table tbody td:nth-child(7) { width: 7%; }
        table.table thead th:nth-child(8), table.table tbody td:nth-child(8) { width: 7%; }
        table.table thead th:nth-child(9), table.table tbody td:nth-child(9) { width: 8%; }
        table.table thead th:nth-child(10), table.table tbody td:nth-child(10) { width: 6%; }
        table.table thead th:nth-child(11), table.table tbody td:nth-child(11) { width: 9%; }
        table.table thead th:nth-child(12), table.table tbody td:nth-child(12) { width: 6%; }
        table.table thead th:nth-child(13), table.table tbody td:nth-child(13) { width: 12%; }

    /* Allow content to wrap so full text is visible; if table is wider than container, allow horizontal scroll */
    table.table td, table.table th { white-space: normal; word-break: break-word; }
    /* Inputs should fill available width */
    table.table td .form-control.edit-mode { max-width: 100%; width: 100%; box-sizing: border-box; }

    /* Actions button group should wrap and not overflow the cell (leave as-is) */
    .btn-group { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
    
    /* Styling for an expanded editing row so inputs are easier to see */
    tr.editing-row td {
        vertical-align: top;
        padding-top: 12px;
        padding-bottom: 12px;
    }

    tr.editing-row td .form-control.edit-mode {
        min-height: 42px;
        white-space: normal;
    }
    /* Mobile-specific improvements: allow horizontal sliding (like Products page) */
    @media (max-width: 767px) {
        /* Let the table be wider than the viewport so user can slide horizontally */
        .table-responsive > table.table, .table-responsive table.table {
            min-width: 1200px; /* increase so columns have more space */
            table-layout: fixed; /* keep column widths stable when sliding */
            font-size: 14px;
        }

        /* Column-specific min-widths to reduce truncation and prioritize important fields */
        /* 2: Mark, 3: Name, 4: Phone, 8: Volume, 9: Price, 13: Actions */
        .table-responsive table.table thead th:nth-child(2),
        .table-responsive table.table tbody td:nth-child(2) { min-width: 140px; }

        .table-responsive table.table thead th:nth-child(3),
        .table-responsive table.table tbody td:nth-child(3) { min-width: 260px; }

        .table-responsive table.table thead th:nth-child(4),
        .table-responsive table.table tbody td:nth-child(4) { min-width: 140px; }

        .table-responsive table.table thead th:nth-child(8),
        .table-responsive table.table tbody td:nth-child(8) { min-width: 110px; }

        .table-responsive table.table thead th:nth-child(9),
        .table-responsive table.table tbody td:nth-child(9) { min-width: 120px; }

        .table-responsive table.table thead th:nth-child(13),
        .table-responsive table.table tbody td:nth-child(13) { min-width: 160px; }

        /* Ensure the responsive container allows touch scrolling */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
        }

        /* Make action buttons larger and allow wrapping */
        .btn-group { gap: 6px; flex-wrap: wrap; }
        .btn-group .btn { padding: 6px 8px; font-size: 13px; }

        /* Provide more vertical spacing for readability */
        table.table td, table.table th { padding: 10px 6px; }

        /* Make view-mode spans take natural height and reduce the min-height used for desktop */
        table.table td .view-mode { min-height: 28px; padding-top: 4px; }

        /* Force single-line rows: prevent wrapping and use ellipsis for overflow */
        table.table th, table.table td {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* Ensure view-mode inline elements also don't wrap */
        table.table td .view-mode, table.table td .client-mark-link {
            display: inline-block; /* allow ellipsis to work reliably */
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        /* Inputs: allow them to still expand but avoid wrapping inside cells */
        table.table td .form-control {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Make icons and clickable badges easier to tap */
        .outstanding-badge i { font-size: 1.1rem; }
    }
    </style>
`);

// When the page is fully loaded, check for outstanding payments
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Check for outstanding payments
    checkOutstandingPaymentsForTable();
});

// Delegated click handlers for buttons that previously used inline onclick attributes
document.addEventListener('click', function(event) {
    const toggleBtn = event.target.closest('.btn-toggle-edit');
    if (toggleBtn) {
        const id = toggleBtn.dataset.shipmentId;
        if (id) {
            openEditShipmentModal(id);
        }
        return;
    }

    const saveBtn = event.target.closest('.btn-save-shipment');
    if (saveBtn) {
        const id = saveBtn.dataset.shipmentId;
        if (id) saveShipment(id);
        return;
    }

    const cancelBtn = event.target.closest('.btn-cancel-shipment');
    if (cancelBtn) {
        const id = cancelBtn.dataset.shipmentId;
        if (id) toggleEditMode(id);
        return;
    }

    const printBtn = event.target.closest('.btn-print-client');
    if (printBtn) {
        const id = printBtn.dataset.shipmentId;
        const currency = printBtn.dataset.currency || 'aed';
        if (id) printClientRow(id, currency);
        return;
    }
});

// Add a reload function that's called after resolving payments
function reloadAfterResolving() {
    // Refresh only the outstanding badges without reloading the page
    checkOutstandingPaymentsForTable();
}
</script>
<!-- Edit Shipment Modal (top pop menu for editing a client/shipment) -->
<div class="modal fade" id="editShipmentModal" tabindex="-1" aria-labelledby="editShipmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="margin-top:30px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editShipmentModalLabel">Edit Client / Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editShipmentForm" action="#" method="POST">
                <div class="modal-body">
                    <div id="editShipmentAlert"></div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Client Mark</label>
                            <input type="text" id="modal_client_mark" class="form-control" disabled>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Client Name</label>
                            <input type="text" id="modal_client_name" class="form-control" disabled>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phone</label>
                            <input type="tel" name="client_phone" id="modal_client_phone" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Tonnage (t)</label>
                            <input type="number" step="0.01" name="tonnage" id="modal_tonnage" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Volume Vide (m³)</label>
                            <input type="number" step="0.01" name="volume_vide" id="modal_volume_vide" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Volume Used (m³)</label>
                            <input type="number" step="0.01" name="volume_used" id="modal_volume_used" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Volume (m³)</label>
                            <input type="number" step="0.01" name="volume" id="modal_volume" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Price (AED)</label>
                            <input type="number" step="0.01" id="modal_price" class="form-control" disabled>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Price per Tonne</label>
                            <input type="number" step="0.01" name="price_per_tonne" id="modal_price_per_tonne" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Extra Charge</label>
                            <input type="number" step="0.01" name="extra_charge" id="modal_extra_charge" class="form-control" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Payment Status</label>
                            <select name="payment_status" id="modal_payment_status" class="form-select">
                                <option value="paid">Paid</option>
                                <option value="unpaid">Unpaid</option>
                                <option value="partial">Partial</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Paid Amount</label>
                            <input type="number" step="0.01" name="paid_amount" id="modal_paid_amount" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openEditShipmentModal(shipmentId) {
    // Find the row for this shipment
    const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
    if (!row) {
        alert('Could not find shipment row to edit');
        return;
    }

    // Populate modal fields from the row
    const clientMark = row.querySelector('td:nth-child(2) a.client-mark-link') ? row.querySelector('td:nth-child(2) a.client-mark-link').textContent.trim() : '';
    const clientName = row.querySelector('td:nth-child(3)').textContent.trim();
    const clientPhoneView = row.querySelector('td:nth-child(4) .view-mode');
    const clientPhone = clientPhoneView ? clientPhoneView.textContent.trim() : '';
    const tonnageInput = row.querySelector('input[name="tonnage"]');
    const volumeVideInput = row.querySelector('input[name="volume_vide"]');
    const volumeUsedInput = row.querySelector('input[name="volume_used"]');
    const volumeInput = row.querySelector('input[name="volume"]');
    const priceInput = row.querySelector('input[name="price"]');
    const pricePerTonneInput = row.querySelector('input[name="price_per_tonne"]');
    const extraChargeInput = row.querySelector('input[name="extra_charge"]');
    const paymentStatusSelect = row.querySelector('select[name="payment_status"]');
    const paidAmountInput = row.querySelector('input[name="paid_amount"]');

    document.getElementById('modal_client_mark').value = clientMark;
    document.getElementById('modal_client_name').value = clientName;
    document.getElementById('modal_client_phone').value = clientPhone;
    document.getElementById('modal_tonnage').value = tonnageInput ? tonnageInput.value : '';
    document.getElementById('modal_volume_vide').value = volumeVideInput ? volumeVideInput.value : '';
    document.getElementById('modal_volume_used').value = volumeUsedInput ? volumeUsedInput.value : '';
    document.getElementById('modal_volume').value = volumeInput ? volumeInput.value : '';
    document.getElementById('modal_price').value = priceInput ? priceInput.value : '';
    document.getElementById('modal_price_per_tonne').value = pricePerTonneInput ? pricePerTonneInput.value : '';
    document.getElementById('modal_extra_charge').value = extraChargeInput ? extraChargeInput.value : 0;
    document.getElementById('modal_payment_status').value = paymentStatusSelect ? paymentStatusSelect.value : 'unpaid';
    document.getElementById('modal_paid_amount').value = paidAmountInput ? paidAmountInput.value : '';

    // Set form action to the shipment edit URL
    const form = document.getElementById('editShipmentForm');
    form.action = `/shipment/${shipmentId}/edit`;

    // Show Bootstrap modal
    const modalEl = document.getElementById('editShipmentModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

// Optional: when the modal's payment_status changes, toggle visibility of paid_amount
document.getElementById('modal_payment_status').addEventListener('change', function() {
    const paidField = document.getElementById('modal_paid_amount');
    if (this.value === 'partial') {
        paidField.parentElement.style.display = '';
    } else {
        paidField.parentElement.style.display = 'block';
        if (this.value === 'paid') paidField.value = document.getElementById('modal_price').value || 0;
        if (this.value === 'unpaid') paidField.value = 0;
    }
});

// Calculate price shown in the Edit Shipment modal when volume/tonnage/etc change
function calculateModalPrice() {
    const modalTonnage = parseFloat(document.getElementById('modal_tonnage').value) || 0;
    const modalPPT = parseFloat(document.getElementById('modal_price_per_tonne').value) || 0;
    const modalVolumeVide = parseFloat(document.getElementById('modal_volume_vide').value) || 0;
    const modalVolumeUsed = parseFloat(document.getElementById('modal_volume_used').value) || 0;
    const modalVolume = parseFloat(document.getElementById('modal_volume').value) || 0;
    const extraCharge = parseFloat(document.getElementById('modal_extra_charge').value) || 0;

    // If tonnage provided and price_per_tonne present, treat as Metals
    if (modalTonnage > 0 && modalPPT > 0) {
        const metalsPrice = Math.round(modalTonnage * modalPPT);
        // For metals, also compute implied volume using server tonne->m3
        const vol = modalTonnage * _tonneToM3_from_config;
        document.getElementById('modal_volume').value = vol.toFixed(2);
        document.getElementById('modal_price').value = metalsPrice;
        return;
    }

    // If modal has car volumes, compute volume and use proportional pricing
    if ((modalVolumeVide > 0) || (modalVolumeUsed > 0 && modalVolumeVide > 0)) {
        const clientVol = Math.max(modalVolumeVide - modalVolumeUsed, 0);
        document.getElementById('modal_volume').value = clientVol.toFixed(2);
        const result = calculateClientPrice(_containerPrice_from_config, _containerVolume_from_config, clientVol, extraCharge);
        document.getElementById('modal_price').value = result.basePrice;
        return;
    }

    // Default: merchandise or explicit volume
    const clientVolume = modalVolume;
    const result = calculateClientPrice(_containerPrice_from_config, _containerVolume_from_config, clientVolume, extraCharge);
    document.getElementById('modal_price').value = result.basePrice;
}

// Helpers to wire modal inputs
document.getElementById('modal_volume').addEventListener('change', calculateModalPrice);
document.getElementById('modal_volume_vide').addEventListener('change', calculateModalPrice);
document.getElementById('modal_volume_used').addEventListener('change', calculateModalPrice);
document.getElementById('modal_tonnage').addEventListener('change', calculateModalPrice);
document.getElementById('modal_price_per_tonne').addEventListener('change', calculateModalPrice);
document.getElementById('modal_extra_charge').addEventListener('change', calculateModalPrice);
</script>
{% endblock %}
